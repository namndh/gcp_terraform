name: 'Terraform CI'

on:
  push:
    branches:
    - main
  pull_requests:

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
  
  steps:
  - name: Checkout
    uses: actions/checkout@v2

  - name: Setup Terraform
    uses: hashicorp/setup-terraform@v1
  
  - name: Terraform Init
    run: terraform init
    end:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
    
  - name: Terraform Format Check
    run: terraform fmt -check
  
  - name: Terraform Plan
    run: terraform plan
    env:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  
  - name: Terraform Apply
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    run: terraform apply -auto-approve
    env:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
